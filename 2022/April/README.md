# 4月报

## Day.16
这是Day.17补的。

今天画了字符串解析状态机的状态迁移图、指令解析状态迁移图、操作数解析状态迁移图、内存操作数状态迁移图。画完了图，代码就很清晰了，有了这几个状态机，后续的汇编指令可以直接使用字符串来构建。

今天还感悟到一个东西：虚拟机的实现。

我们将cpu和内存抽象出来，用一些结构体变量来表示，cpu由一堆寄存器组成，内存直接就是一个大数组，仅仅这两个东西就可以组成最简单的虚拟机。寄存器变量模拟寄存器，保存单个数据(uint64_t)，并且通过`va2pa()`可以将寄存器变量中保存的虚拟地址转换到内存数组的实际下标。

首先将汇编指令写到内存数组中，然后寄存器去访问内存并读取指令，解析运行后移动指令指针（下一条或者跳转）,这样循环起l来，就是一个最简单的虚拟机了。

## Day.17

今天看完了CSAPP的第三章，对计算机的指令执行体系有了新的认知。

相比于昨天的内容，今天主要是实现了一下汇编指令。`mov call ret push pop` 这几个是前几节课里面讲过的，之前没有写这次补上了，`mov push pop`都是为了某些实验指令特定实现的，参数不通用。`add sub leave jmp jne`这是今天新讲的，涉及到cpu标志位，使用一个`union`+ `struct`实现，可以节省内存，方便清零。其中的`OF`标志格外需要注意，需要推导一下各种溢出情况：同号才会溢出，同号又有两种情况。

这些实现完了，微型虚拟机就完成了（大佬也说这个像虚拟机，我居然猜对了）。

链接开了个头，比较模糊，感觉挺像设计数据存储的，也有magic number之类的，明天好好总结一下。
